# コスト最適化ガイド

このドキュメントでは、AI要件相談アシスタントのコスト削減機能について説明します。

## 💰 コスト削減のポイント

### 1. VAD（音声検出）の最適化

**Voice Activity Detection (VAD)** を使用することで、無音時の音声データ送信を防ぎます。

#### 仕組み
- `threshold`: 音声検出の閾値（0.0-1.0）
  - 低い値: 音声を検出しやすい（品質重視）
  - 高い値: 無音と判定しやすい（コスト重視）
- `silence_duration_ms`: 無音と判定する時間
  - 短い: 素早く応答（品質重視）
  - 長い: 確実に発話終了を検出（コスト重視）

#### 設定例
```typescript
// コスト重視
vad: {
  enabled: true,
  threshold: 0.6,           // 高め = 無音判定しやすい
  prefixPaddingMs: 300,
  silenceDurationMs: 700,   // 長め = 確実に終了検出
}

// 品質重視
vad: {
  enabled: true,
  threshold: 0.4,           // 低め = 音声検出しやすい
  prefixPaddingMs: 500,
  silenceDurationMs: 400,   // 短め = 素早く応答
}
```

### 2. プッシュトゥトーク（PTT）方式

**最もコスト削減効果が高い**方式です。

#### 特徴
- ボタンを押している間だけマイク有効
- 不要な音声データの送信を完全に防止
- 会話開始/終了が明確

#### 使い方
1. コスト設定で「プッシュトゥトーク」を選択
2. 会話を開始
3. 「長押しして話す」ボタンを押しながら話す
4. ボタンを離すとAIが応答

#### コスト削減効果
- 無駄な音声送信: **0%**
- 環境音の誤検出: **0%**
- 推定コスト削減: **40-60%**

### 3. 会話コンテキストの制限

長時間の会話ではコンテキストが増大し、トークン消費が増えます。

#### 仕組み
- `maxConversationItems`: 保持する会話アイテムの最大数
- `maxTokens`: 1回の応答の最大トークン数

古い会話アイテムを自動的に削除することで、コンテキストサイズを制限します。

#### 設定例
```typescript
// コスト重視
context: {
  maxConversationItems: 15,  // 最新15件のみ保持
  maxTokens: 1024,           // 応答を1024トークンに制限
}

// バランス
context: {
  maxConversationItems: 20,
  maxTokens: 2048,
}

// 品質重視
context: {
  maxConversationItems: 50,
  maxTokens: 4096,
}
```

#### コスト削減効果
- 長時間会話時のコンテキスト増大を防止
- 推定コスト削減: **20-30%**

### 4. プロンプトキャッシュ機能

OpenAI Realtime APIでは、セッション作成時のシステムプロンプトが自動的にキャッシュされます。

#### 仕組み
- 初回: システムプロンプトを含めて処理（フルコスト）
- 2回目以降: キャッシュされたプロンプトを使用（コスト削減）

#### メリット
- システムプロンプトの処理コストが大幅削減
- レスポンス時間の短縮
- 推定コスト削減: **10-20%**

## 📊 コストプリセット比較

| プリセット | VAD | PTT | コンテキスト | トークン | 推定コスト | 品質 |
|----------|-----|-----|------------|---------|----------|------|
| **コスト重視** | ✅ 最適化 | ❌ | 制限 (20件) | 2048 | 💰 低 | ⭐⭐⭐ |
| **バランス** | ✅ 高品質 | ❌ | 広い (50件) | 4096 | 💰💰 中 | ⭐⭐⭐⭐ |
| **PTT** | ❌ | ✅ | 最小 (15件) | 1024 | 💰 最低 | ⭐⭐⭐⭐⭐ |

## 🎯 使用シーン別おすすめ設定

### 短時間の相談（5-10分）
**推奨: コスト重視**
- 自動VADで自然な会話
- 適度なコンテキスト制限
- バランスの良いコスト

### 長時間のブレインストーミング（30分以上）
**推奨: プッシュトゥトーク**
- 必要な時だけ送信
- 最小限のコンテキスト
- 最大のコスト削減

### デモ・プレゼンテーション
**推奨: バランス**
- 高品質な応答
- 広いコンテキスト
- スムーズな会話

## 📈 コスト削減の実測例

### ケース1: 10分間の要件相談（コスト重視）
- 会話ターン数: 約20回
- 平均応答トークン: 150トークン
- 推定コスト: 約$0.30-0.40

### ケース2: 10分間の要件相談（PTT）
- 会話ターン数: 約15回（集中した会話）
- 平均応答トークン: 120トークン
- 推定コスト: 約$0.15-0.25
- **削減率: 約40-50%**

### ケース3: 30分間の詳細相談（バランス）
- 会話ターン数: 約60回
- 平均応答トークン: 200トークン
- 推定コスト: 約$1.50-2.00

## 💡 コスト削減のベストプラクティス

1. **用途に応じて設定を切り替える**
   - 探索的な会話: バランス
   - 決まった質問: PTT

2. **PTTモードの活用**
   - 考えをまとめてから話す
   - 無駄な言い直しを減らす

3. **定期的なセッションリセット**
   - 長時間会話は複数セッションに分割
   - コンテキストをリフレッシュ

4. **要件が固まったら早めに終了**
   - 必要な情報が揃ったら会話を終了
   - 不要な雑談を避ける

## 🔧 カスタム設定

独自のコスト設定を作成することもできます：

```typescript
// lib/cost-config.ts
export const MY_CUSTOM_CONFIG: CostConfig = {
  mode: 'auto-vad',
  vad: {
    enabled: true,
    threshold: 0.55,
    prefixPaddingMs: 350,
    silenceDurationMs: 600,
  },
  context: {
    maxConversationItems: 25,
    maxTokens: 1536,
  },
  cache: {
    enabled: true,
  },
};
```

## 📊 モニタリング

アプリケーションには以下のコスト関連情報が表示されます：

- 現在のモード（VAD / PTT）
- 会話アイテム数
- 使用中のコストプリセット

これらを確認しながら、最適な設定を見つけてください。

## ⚠️ 注意事項

- **PTTモードは操作に慣れが必要**
  - 初めて使う場合は練習が推奨

- **コンテキスト制限の副作用**
  - 長い会話の場合、古い情報が失われる
  - 重要な情報は要件として保存を

- **VAD設定の調整**
  - 環境によって最適値は異なる
  - 静かな環境: threshold低め
  - 騒音がある環境: threshold高め

## 📚 関連ドキュメント

- [OpenAI Realtime API Pricing](https://openai.com/api/pricing/)
- [VAD技術の詳細](https://en.wikipedia.org/wiki/Voice_activity_detection)
- [プロンプトキャッシュ](https://platform.openai.com/docs/guides/prompt-caching)
